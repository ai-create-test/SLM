# NeuralFlow æ–°æ‰‹å…¥é—¨æŒ‡å—

> ğŸ¯ **ç›®æ ‡è¯»è€…ï¼š** å®Œå…¨æ²¡æœ‰æ¥è§¦è¿‡æœ¬é¡¹ç›®çš„æ–°æ‰‹
> 
> â±ï¸ **é¢„è®¡æ—¶é—´ï¼š** 30 åˆ†é’Ÿå®Œæˆç¬¬ä¸€æ¬¡è®­ç»ƒ

---

## ğŸ“‹ å¼€å§‹ä¹‹å‰

### ä½ éœ€è¦å‡†å¤‡

| é¡¹ç›® | æœ€ä½è¦æ±‚ | æ¨èé…ç½® |
|------|---------|----------|
| Python | 3.10+ | 3.11 |
| å†…å­˜ | 8GB | 16GB |
| GPU | å¯é€‰ | NVIDIA RTX 3060+ |
| ç£ç›˜ | 2GB | 10GB |

### æ£€æŸ¥ç¯å¢ƒ

æ‰“å¼€å‘½ä»¤è¡Œ (Windows æŒ‰ `Win+R`ï¼Œè¾“å…¥ `cmd`)ï¼š

```bash
python --version
# åº”è¯¥æ˜¾ç¤º Python 3.10 æˆ–æ›´é«˜ç‰ˆæœ¬
```

---

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šå®‰è£…é¡¹ç›®

### 1.1 ä¸‹è½½ä»£ç 

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-username/neuralflow.git

# è¿›å…¥ç›®å½•
cd neuralflow
```

### 1.2 å®‰è£…ä¾èµ–

```bash
# å®‰è£…æ‰€éœ€åº“
pip install -r requirements.txt
```

**å¸¸è§é—®é¢˜ï¼š**
- å¦‚æœå®‰è£…å¤±è´¥ï¼Œå°è¯• `pip install --upgrade pip` åé‡è¯•
- å›½å†…ç”¨æˆ·å¯ä½¿ç”¨é•œåƒï¼š`pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple`

### 1.3 éªŒè¯å®‰è£…

```bash
python tests/test_e2e_pipeline.py
```

å¦‚æœçœ‹åˆ° `ALL TESTS PASSED` å°±è¯´æ˜å®‰è£…æˆåŠŸï¼

---

## ğŸ“ ç¬¬äºŒæ­¥ï¼šå‡†å¤‡è®­ç»ƒæ•°æ®

### 2.1 æ•°æ®æ ¼å¼

NeuralFlow ä½¿ç”¨ **JSONL** æ ¼å¼ (æ¯è¡Œä¸€ä¸ª JSON)ï¼š

```jsonl
{"text": "ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œé˜³å…‰æ˜åªšã€‚"}
{"text": "è¿™æ˜¯ä¸€ä¸ªå…³äºäººå·¥æ™ºèƒ½çš„æ®µè½ã€‚"}
{"text": "æœºå™¨å­¦ä¹ æ­£åœ¨æ”¹å˜æˆ‘ä»¬çš„ç”Ÿæ´»ã€‚"}
```

### 2.2 åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªæ•°æ®é›†

1. åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º `data` æ–‡ä»¶å¤¹
2. åˆ›å»ºæ–‡ä»¶ `data/my_data.jsonl`
3. å†™å…¥è‡³å°‘ 10 ä¸ªæ®µè½ï¼ˆè¶Šå¤šè¶Šå¥½ï¼‰

**ç¤ºä¾‹æ•°æ®ï¼ˆå¤åˆ¶ä¿å­˜ä¸º `data/my_data.jsonl`ï¼‰ï¼š**

```jsonl
{"text": "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒè¯•å›¾ç†è§£æ™ºèƒ½çš„æœ¬è´¨ã€‚"}
{"text": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„æ ¸å¿ƒæ–¹æ³•ï¼Œé€šè¿‡æ•°æ®é©±åŠ¨æ¨¡å‹è®­ç»ƒã€‚"}
{"text": "æ·±åº¦å­¦ä¹ ä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œï¼Œèƒ½å¤Ÿè‡ªåŠ¨å­¦ä¹ æ•°æ®çš„å±‚æ¬¡ç‰¹å¾ã€‚"}
{"text": "è‡ªç„¶è¯­è¨€å¤„ç†è®©è®¡ç®—æœºèƒ½å¤Ÿç†è§£å’Œç”Ÿæˆäººç±»è¯­è¨€ã€‚"}
{"text": "è®¡ç®—æœºè§†è§‰ä½¿æœºå™¨èƒ½å¤Ÿç†è§£å›¾åƒå’Œè§†é¢‘å†…å®¹ã€‚"}
{"text": "å¼ºåŒ–å­¦ä¹ é€šè¿‡è¯•é”™æ¥å­¦ä¹ æœ€ä¼˜ç­–ç•¥ï¼ŒAlphaGo å°±æ˜¯å…¸å‹åº”ç”¨ã€‚"}
{"text": "Transformer æ¶æ„é©æ–°äº†è‡ªç„¶è¯­è¨€å¤„ç†ï¼Œæ˜¯ GPT ç­‰æ¨¡å‹çš„åŸºç¡€ã€‚"}
{"text": "å¤§è¯­è¨€æ¨¡å‹é€šè¿‡æµ·é‡æ–‡æœ¬è®­ç»ƒï¼Œå±•ç°å‡ºæƒŠäººçš„è¯­è¨€èƒ½åŠ›ã€‚"}
{"text": "ç¥ç»ç½‘ç»œå—äººè„‘å¯å‘ï¼Œç”±å¤§é‡ç¥ç»å…ƒç›¸äº’è¿æ¥ç»„æˆã€‚"}
{"text": "GPU åŠ é€Ÿä½¿æ·±åº¦å­¦ä¹ è®­ç»ƒæˆä¸ºå¯èƒ½ï¼Œå¤§å¤§ç¼©çŸ­äº†è®­ç»ƒæ—¶é—´ã€‚"}
```

### 2.3 éªŒè¯æ•°æ®

```bash
python -c "
from app.training.data_loader import ParagraphDataset
dataset = ParagraphDataset.from_jsonl('data/my_data.jsonl')
print(f'æˆåŠŸåŠ è½½ {len(dataset)} ä¸ªæ®µè½')
print(f'ç¬¬ä¸€ä¸ªæ®µè½: {dataset[0][:50]}...')
"
```

---

## ğŸ“ ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹è®­ç»ƒ

### 3.1 ä½¿ç”¨æœ€ç®€å•çš„å‘½ä»¤

```bash
python scripts/train.py \
    --preset small \
    --data data/my_data.jsonl \
    --output outputs/my_first_model \
    --epochs 5
```

**å‚æ•°è¯´æ˜ï¼š**
- `--preset small`: ä½¿ç”¨å°å‹æ¨¡å‹ï¼ˆ2äº¿å‚æ•°ï¼Œé€‚åˆå…¥é—¨ï¼‰
- `--data`: ä½ çš„æ•°æ®æ–‡ä»¶è·¯å¾„
- `--output`: æ¨¡å‹ä¿å­˜ä½ç½®
- `--epochs`: è®­ç»ƒè½®æ•°ï¼ˆæ–°æ‰‹ä» 5 å¼€å§‹ï¼‰

### 3.2 è§‚å¯Ÿè®­ç»ƒè¾“å‡º

è®­ç»ƒæ—¶ä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
[Stage 1 VQ-VAE] Epoch 1/5 | Loss: 0.0234
[Stage 1 VQ-VAE] Epoch 2/5 | Loss: 0.0198
...
[Stage 2 Dynamics] Epoch 1/5 | Loss: 0.5432
[Stage 2 Dynamics] Epoch 2/5 | Loss: 0.3210
...
Training completed! Model saved to outputs/my_first_model
```

### 3.3 è®­ç»ƒéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

| æ•°æ®é‡ | CPU | GPU |
|-------|-----|-----|
| 100 æ®µè½ | ~5 åˆ†é’Ÿ | ~1 åˆ†é’Ÿ |
| 1000 æ®µè½ | ~30 åˆ†é’Ÿ | ~5 åˆ†é’Ÿ |
| 10000 æ®µè½ | ~4 å°æ—¶ | ~30 åˆ†é’Ÿ |

---

## ğŸ”® ç¬¬å››æ­¥ï¼šä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹

### 4.1 åŠ è½½æ¨¡å‹

```python
from app.model import NeuralFlowModel
import torch

# åŠ è½½æ¨¡å‹
model = NeuralFlowModel.from_checkpoint('outputs/my_first_model/best.pt')
model.eval()
```

### 4.2 ç¼–ç æ®µè½

```python
# å°†æ–‡æœ¬ç¼–ç ä¸ºæ½œå‘é‡
text = "äººå·¥æ™ºèƒ½æ­£åœ¨å¿«é€Ÿå‘å±•"
with torch.no_grad():
    output = model.encoder([text])
    latent = output.latent
    print(f"æ½œå‘é‡ç»´åº¦: {latent.shape}")
```

### 4.3 ç”Ÿæˆæ–‡æœ¬

```python
# ä»æ½œå‘é‡ç”Ÿæˆæ–‡æœ¬
with torch.no_grad():
    generated = model.decoder.generate(latent, max_length=64)
    print(f"ç”Ÿæˆçš„æ–‡æœ¬: {generated.text[0]}")
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: æ˜¾ç¤º "CUDA out of memory"

**åŸå› ï¼š** GPU å†…å­˜ä¸è¶³

**è§£å†³ï¼š** å‡å°æ‰¹æ¬¡å¤§å°
```bash
python scripts/train.py --preset small --data data/my_data.jsonl --training.batch_size 4
```

### Q2: è®­ç»ƒå¾ˆæ…¢

**è§£å†³æ–¹æ¡ˆï¼š**
1. ä½¿ç”¨ GPUï¼ˆå¦‚æœæœ‰ï¼‰
2. å‡å°‘ epochs æ•°é‡
3. ä½¿ç”¨ `--preset tiny` è¿›è¡Œå¿«é€Ÿæµ‹è¯•

### Q3: ç”Ÿæˆçš„æ–‡æœ¬æ˜¯ä¹±ç 

**åŸå› ï¼š** æ¨¡å‹è®­ç»ƒä¸è¶³æˆ–æ•°æ®å¤ªå°‘

**è§£å†³ï¼š**
1. å¢åŠ è®­ç»ƒæ•°æ®ï¼ˆè‡³å°‘ 100+ æ®µè½ï¼‰
2. å¢åŠ è®­ç»ƒè½®æ•°ï¼ˆ`--epochs 20`ï¼‰
3. æ£€æŸ¥æ•°æ®è´¨é‡

### Q4: ä¸çŸ¥é“æ€ä¹ˆè·å–æ›´å¤šæ•°æ®

**æ•°æ®æ¥æºå»ºè®®ï¼š**
- ç»´åŸºç™¾ç§‘æ–‡ç« æ®µè½
- æ–°é—»ç½‘ç«™æ–‡ç« 
- å°è¯´ç« èŠ‚
- åšå®¢æ–‡ç« 

**æ•°æ®æ ¼å¼è½¬æ¢è„šæœ¬ï¼š**
```python
import json

# å°†çº¯æ–‡æœ¬è½¬ä¸º JSONL
with open('raw_text.txt', 'r', encoding='utf-8') as f:
    text = f.read()

# æŒ‰ç©ºè¡Œåˆ†å‰²æ®µè½
paragraphs = [p.strip() for p in text.split('\n\n') if p.strip()]

with open('data/converted.jsonl', 'w', encoding='utf-8') as f:
    for p in paragraphs:
        json.dump({'text': p}, f, ensure_ascii=False)
        f.write('\n')

print(f'è½¬æ¢å®Œæˆ: {len(paragraphs)} ä¸ªæ®µè½')
```

---

## ğŸ“Š è¿›é˜¶ï¼šç†è§£è®­ç»ƒé˜¶æ®µ

NeuralFlow é‡‡ç”¨ **4 é˜¶æ®µè®­ç»ƒ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 1    â”‚ --> â”‚  Stage 2    â”‚ --> â”‚  Stage 3    â”‚ --> â”‚  Stage 4    â”‚
â”‚  VQ-VAE     â”‚     â”‚  Dynamics   â”‚     â”‚  Emotion    â”‚     â”‚  Finetune   â”‚
â”‚  å­¦ä¹ å‹ç¼©    â”‚     â”‚  å­¦ä¹ é¢„æµ‹    â”‚     â”‚  å­¦ä¹ æƒ…æ„Ÿ    â”‚     â”‚  æ•´ä½“å¾®è°ƒ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ–°æ‰‹å»ºè®®ï¼šå…ˆåªè¿è¡Œ Stage 1 å’Œ Stage 2**

```bash
python scripts/train.py --preset small --data data/my_data.jsonl --stages vqvae dynamics
```

---

## ğŸ‰ æ­å–œï¼

ä½ å·²ç»å®Œæˆäº†ï¼š
- âœ… å®‰è£… NeuralFlow
- âœ… å‡†å¤‡è®­ç»ƒæ•°æ®
- âœ… è®­ç»ƒç¬¬ä¸€ä¸ªæ¨¡å‹
- âœ… ä½¿ç”¨æ¨¡å‹ç”Ÿæˆæ–‡æœ¬

**ä¸‹ä¸€æ­¥å»ºè®®ï¼š**
1. é˜…è¯»å®Œæ•´æ–‡æ¡£ï¼š`docs/TRAINING.md`
2. å°è¯•æ›´å¤§çš„æ•°æ®é›†
3. è°ƒæ•´æ¨¡å‹å‚æ•°
4. æ¢ç´¢äº‘ç«¯è®­ç»ƒ

**æœ‰é—®é¢˜ï¼Ÿ**
- æŸ¥çœ‹ `docs/TRAINING.md` çš„ FAQ éƒ¨åˆ†
- æäº¤ GitHub Issue

---

*æœ¬æŒ‡å—ä½¿ç”¨ NeuralFlow v1.0 ç¼–å†™*
